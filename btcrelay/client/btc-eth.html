<!DOCTYPE html>
<html lang="en">
<head>
  <title>Ethereum: get ether with bitcoin</title>
  <link rel="stylesheet" href="./css/bootstrap.min.css">
  <link rel="stylesheet" href="./css/dapp.css">
  <script src="./js/jquery-2.1.3.min.js"></script>
  <script src="./js/bootstrap.min.js"></script>

  <!-- TODO btcRelayAbi.js is only needed for testing verifyTx -->
  <script src="./js/btcRelayAbi.js"></script>

  <script src="./js/btcBridgeAbi.js"></script>
  <script src="./js/btc-ethAbi.js"></script>


  <!-- TODO may not all be needed -->
  <!--
  <script src="http://crypto-js.googlecode.com/svn/tags/3.1.2/build/components/core-min.js"></script>
  <script src="http://crypto-js.googlecode.com/svn/tags/3.1.2/build/components/enc-utf16-min.js"></script>
  <script src="http://crypto-js.googlecode.com/svn/tags/3.1.2/build/components/enc-base64-min.js"></script>
  -->

  <script src="./js/bignumber.js"></script>
  <script src="./js/ethereum.min.js"></script>


  <script src="./js/btcproof.js"></script>

<script type="text/javascript">
var web3 = require('web3');
    web3.setProvider(new web3.providers.HttpProvider('http://localhost:8080'));  // port 8545 for Mist

// web3.setProvider(new web3.providers.AutoProvider());
// web3.setProvider(new web3.providers.WebSocketProvider('ws://localhost:40404/eth'));

///First web3.eth.watch code to monitor coinbase
// web3.eth.watch('pending').changed(function(){
//     var coinbase = web3.eth.coinbase;
//   	document.getElementById('coinbase').innerText = coinbase;
//
//     var balance = web3.eth.balanceAt(coinbase);
//   	document.getElementById('balance').innerText = balance;
// });

var btcproof = require('btcproof');

///Insert your contract address var here:


///Second web3.eth.watch code to monitor block number
// web3.eth.watch().changed(function(){
// 	web3.eth.block(web3.eth.number).then(function(result){
//     	document.getElementById('latestBlock').innerText = web3.eth.number._result;
//     	document.getElementById('latestBlockHash').innerText = result.hash;
//     	document.getElementById('latestBlockTimestamp').innerText = Date(result.timestamp);
//   	})
// });


// curl -X POST --data '{"jsonrpc":"2.0","method":"eth_balanceAt","params":["0x205215f022af4950618730bcfae161b28397bc41"],"id":1}' http://localhost:8080


// def verifyTx(tx, proofLen, hash:arr, path:arr, txBlockHash):

// note this version of btcrelay does not getChainScore, or return blockChainHead...
// 0x3432c7f5ca6552fca2f641575135578cb724eb1f


var gExchangeContractAddr = '0x'+'79add0b11f29130a8aca966124715dedfe6d418a';
var gOurBtcAddr = '61cf5af7bb84348df3fd695672e53c7d5b3f3db9'  // tx1 of block300K
// var gOurBtcAddr = 'c398efa9c392ba6013c5e04ee729755ef7f58b32'  // tx1 of block100K



// This requires that blocks are from block100K (instead of 300K)
// this should no longer work because processTransfer can only
// be called by the (trusted) BtcRelay contract
function c44allContract() {
  console.log('@@@ in testDirectProcessTransfer')
  console.log('@@@ btcToEthAbi: ', btcToEthAbi, ' gExchangeContractAddr: ', gExchangeContractAddr)


  var addrExchContract = gExchangeContractAddr;
  var exch = web3.eth.contract(addrExchContract, btcToEthAbi);

  var txHex = '0100000001032e38e9c0a84c6046d687d10556dcacc41d275ec55fc00779ac88fdf357a187000000008c493046022100c352d3dd993a981beba4a63ad15c209275ca9470abfcd57da93b58e4eb5dce82022100840792bc1f456062819f15d33ee7055cf7b5ee1af1ebcc6028d9cdb1c3af7748014104f46db5e9d61a9dc27b8d64ad23e7383a4e6ca164593c2527c038c0857eb67ee8e825dca65046b82c9331586c82e0fd1f633f25f87c161bc6f8a630121df2b3d3ffffffff0200e32321000000001976a914c398efa9c392ba6013c5e04ee729755ef7f58b3288ac000fe208010000001976a914948c765a6914d43f2a7ac177da2c2f6b52de3d7c88ac00000000';
  var res = exch.call().processTransfer(txHex);
  // var res = exch.transact().processTransfer(txHex);
  console.log('@@@@ res.toString(10): ', res.toString(10))
  if (res) {
    document.getElementById('result').innerText = res.toString(10);
  }

  // web3.eth.filter({'address': gExchangeContractAddr, 'max': 10}).watch(function(res) {
  //   console.log('@@@ gExchangeContractAddr filter')
  //   console.log(res)
  // });
}


// web3.eth.filter({'address': gExchangeContractAddr, 'max': 10}).watch(function(res) {
//   console.log('@@@ gExchangeContractAddr filter')
//   console.log(res)
// });
//
//
// web3.eth.filter('pending').watch(function (log) {
//   console.log('@@@ pending filter')
//   console.log(log); //  {"address":"0x0000000000000000000000000000000000000000","data":"0x0000000000000000000000000000000000000000000000000000000000000000","number":0}
// });
//
//
// web3.eth.filter('chain').watch(function (log) {
//   console.log('@@@ chain filter')
//   console.log(log); //  {"address":"0x0000000000000000000000000000000000000000","data":"0x0000000000000000000000000000000000000000000000000000000000000000","number":0}
// });





var gMerkleProof;
var gBlockHashOfTx;
var gRawTx;
function callContract() {
  console.log('@@@ in callContract')
  console.log('@@@ btcRelayAbi: ', btcRelayAbi)
  console.log('@@@ btcBridgeAbi: ', btcBridgeAbi)

  var verifyTx;
  // verifyTx = true;  // if commented, it will call relayTx


  // TODO don't forget to update the ABI (btcRelayAbi.js & btcEthAbi.js)
  //
  // TODO relayTx is in bridge/bulk abi; verifyTx is in btcRelayAbi.js
  // for btcRelayAbi.js, since btcrelay was split up, need to
  // use bridge/bulk such as serpent mk_full_signature ~/projects/eth/dapp-bin/btcrelay/btcBulkStoreHeaders.py > client/js/btcRelayAbi.js
  // when the Serpent is updated
  // for relayTx, bethAddress is address of bridge/bulkBridge contract
  // for verifyTx, bethAddress is address of btcrelay contract
  var bethAddress;
  var abiToUse;
  if (verifyTx) {
    bethAddress = '0x'+'cf2d91e4a42568344d6222f08003db3104f3cddd';
    abiToUse = btcRelayAbi;
  }
  else {
    bethAddress = '0x'+'205215f022af4950618730bcfae161b28397bc41';
    abiToUse = btcBridgeAbi;
  }

  var contract = web3.eth.contract(bethAddress, abiToUse);
  console.log('@@@@ contract: ', contract)

  // block300K tx1
  // var tx1300K = '7301b595279ece985f0c415e420e425451fcf7f684fcce087ba14d10ffec1121';

  var transHex = $('#transHex').val();
  // TODO check if transHex is prefixed with 0x
  var txHash = new BigNumber('0x' + transHex);


  var merkleSibling = [];
  var merklePath = [];
  gMerkleProof.forEach(function(proof) {
    merkleSibling.push(new BigNumber('0x'+proof.hash));
    merklePath.push(proof.path);
  })

  // console.log('$$$$$$$$', merkleSibling)
  // console.log('$$$$$$$$', merklePath)

  var proofLen = merkleSibling.length;
  // var merklePath = [new BigNumber(1), new BigNumber(2)];
  // var proofLen = new BigNumber(merkleSibling.length);
  var txBlockHash = new BigNumber('0x'+gBlockHashOfTx);



  if (verifyTx) {
    var startTime = Date.now();
    var res = contract.call().verifyTx(txHash, proofLen, merkleSibling, merklePath, txBlockHash);
    var endTime = Date.now();
    var durationSec = (endTime - startTime) / 1000;
    console.log('@@@@ verifyTx res: ', res, ' duration: ', durationSec)
    document.getElementById('result').innerText = res.toString(10) + "    " + durationSec+ "secs";
    return
  }



  var txHex = gRawTx;
  // var words = CryptoJS.enc.Hex.parse(txHex);
  // var txBinaryStr = CryptoJS.enc.Latin1.stringify(words);

  var exchangeContractAddr = new BigNumber(gExchangeContractAddr);

  var startTime = Date.now();
  var res = contract.sendTransaction().relayTx(txHex, txHash, proofLen, merkleSibling, merklePath, txBlockHash, exchangeContractAddr);
  var endTime = Date.now();
  var durationSec = (endTime - startTime) / 1000;
  console.log('@@@@ relayTx res: ', res, ' duration: ', durationSec)
  document.getElementById('result').innerText = res.toString(10) + "    " + durationSec+ "secs";

}



// fff2525b8931402dd09222c50775608f75787bd2b87e56995a7bdd30f79702c4
function getTxInfo() {
  var txid = $('#transHex').val();
  console.log('@@@ txid: ', txid);

  var urlHexTx = "https://blockchain.info/rawtx/"+txid+"?format=hex&cors=true";
  $.ajax(urlHexTx).done(function(data) {
      // console.log('@@@ hex: ', data)
      gRawTx = data;
      $('#txHexText').val(gRawTx);
  });


  var urlJsonTx = "https://blockchain.info/rawtx/"+txid+"?format=json&cors=true";
  $.getJSON(urlJsonTx, function(data) {
      console.log('@@@ bd: ', data)
      var blockNum = data.block_height;
      $('#txBlockNum').text(blockNum);

      var blockInfoUrl = "http://btc.blockr.io/api/v1/block/raw/"+blockNum;
      $.getJSON(blockInfoUrl, function(res) {
          console.log('@@@ res: ', res)

          gBlockHashOfTx = res.data.hash;
          $('#txBlockHash').text(gBlockHashOfTx)

          gMerkleProof = btcproof.getProof(res.data.tx, 1);
          console.log('@@@ mp: ', gMerkleProof)
          $('#mProof').val(JSON.stringify(gMerkleProof));
      })

  })
}

$(function() {
  var ethBalance = web3.fromWei(web3.eth.balanceAt(gExchangeContractAddr), 'ether');
  $('#exchBal').text(ethBalance);

  // $('#transHex').val('fff2525b8931402dd09222c50775608f75787bd2b87e56995a7bdd30f79702c4');

  $('#transHex').val('7301b595279ece985f0c415e420e425451fcf7f684fcce087ba14d10ffec1121');


  $('#btn-get-tx').click(getTxInfo);

  $('#exchAddr').text(gExchangeContractAddr);
  $('#ourBtcAddr').text(gOurBtcAddr)
});



</script>

</head>

<body>

  <div class="container">
    <div class="logo">
      <img src="./images/ethereum-logo-small.png"/>
    </div>

    <h2>Get ether with bitcoin <small>&nbsp;&nbsp;&nbsp; 1000 ether per 1BTC</small></h2>

    <p class="lead">Contract at <span id="exchAddr"></span> has
      <span id="exchBal"></span> ether.
      <br>
      To get ether, submit 1 Bitcoin transaction with 2 outputs:</p>
    <ul>
      <li>1st sending BTC to <strong id="ourBtcAddr"></strong></li>
      <li>2nd sending 0.0001 BTC to <strong>your</strong> Ethereum Address</li>
    </ul>

    <p>After sending the BTC, <strong>Lookup</strong> the hash of your
      Bitcoin transaction here, and then click
      <strong>Claim Ether</strong> below.
    </p>

    <form class="form-inline">
      <div class="form-group">
        <label for="transHex">Transaction Hash</label>
        <input type="text" class="form-control" id="transHex" size="64" maxlength="64"></input>
      </div>
      <button type="button" class="btn btn-default" id="btn-get-tx">Lookup</button>
    </form>

    <hr>

    <!-- <form>
      <div class="form-group">
        <label for="blockNum">Choose block number</label>
        <input type="text" class="form-control" id="blockNum"></input>
        <button type="button" class="btn btn-default" id="btn-get-tx">Submit</button>
      </div>
    </form> -->

    <form>
      <div class="form-group">
        <label for="txHexText">Raw Transaction</label>
        <textarea readonly class="form-control" name="textarea" id="txHexText" rows="6" cols="50"></textarea>

        <label for="mProof">Merkle Proof</label>
        <textarea readonly class="form-control" name="textarea" id="mProof" rows="6" cols="50"></textarea>

        <label class="col-md-1 control-label">Block Number</label>
        <div class="col-md-1">
          <p class="form-control-static" id="txBlockNum">0</p>
        </div>

        <label class="col-md-1 control-label">Block Hash</label>
        <div class="col-md-9">
          <p class="form-control-static" id="txBlockHash">0</p>
        </div>
      </div>
      <br><br>
      <button type="button" class="btn btn-default" onclick="callContract();">Claim Ether</button>
    </form>


    <div id="result"></div>

    <!-- <div class="jumbotron">
      <h5>Coinbase Address: <strong id="coinbase"></strong></h5>
      <h5>Balance: <strong id="balance"></strong></h5>
      <h5>Latest Block Number: <strong id="latestBlock"></strong></h5>
      <h5>Latest Block Timestamp: <strong id="latestBlockTimestamp"></strong></h5>
      <h5>Latest Block Hash: <strong id="latestBlockHash"></strong></h5>
      <br>
    </div> -->

    <div class="footer-logo">
      <img src="./images/ETH_DEV_LOGO_LARGE.svg"/>
    </div>
  </div>

</body>

</html>
